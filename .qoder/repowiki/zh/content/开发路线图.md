# Backtrader 项目发展路线图

> 本文档记录项目当前状态评估与未来发展任务清单，目标是将 backtrader 发展为成熟的实盘/回测量化交易系统。

---

## 一、项目现状评估

### 1.1 总体评分

| 领域 | 完成度 | 评价 |
|------|--------|------|
| 核心回测框架 | 95% | 生产级，功能完整 |
| 技术指标库 | 95% | 51+ 内置指标 + TA-Lib 集成 |
| 分析器 | 95% | 16+ 分析器（Sharpe/Drawdown/Returns 等） |
| 风险管理模块 | 95% | 仓位计算 / 止损 / 回撤控制 / 交易限制 |
| 数据源 | 85% | 18+ 数据源，离线 + 在线 |
| 通用工具（Utils） | 90% | 配置 / 日志 / 重试 / 校验 |
| 实盘通用基类（Common） | 90% | Store / Broker / Data / WebSocket 基类 |
| 监控与通知 | 65-70% | 基本可用，缺持久化和告警去重 |
| 实盘交易引擎 | 50% | 骨架可用，缺状态恢复 |
| 策略库 | 50% | 骨架实现，缺风控集成 |
| Binance 交易所集成 | 40% | 基础可用，缺 WebSocket 和完整订单管理 |
| 测试覆盖 | 40% | 核心框架有测试，实盘模块严重不足 |
| WebSocket 实时流 | 40% | 有基类但未在交易所模块中集成 |
| 工具链 / CI/CD | 60% | 基本工具有，缺 Docker 和现代 CI |
| 数据库持久化 | 0% | 完全缺失 |

### 1.2 各模块详细状态

#### 核心回测框架（完全实现）

- **Cerebro 引擎**：~1,700 行，回测核心运行器
- **Strategy 基类**：~1,718 行，策略生命周期管理
- **BackBroker**：~1,600 行，市价单/限价单/止损单/OCO/括号单、滑点模拟
- **Order/Trade**：~950 行，完整的订单和交易对象模型
- **LineBuffer/LineSeries**：行缓冲和时间序列引擎
- **多时间框架**：Resampler / Replayer 支持
- **参数优化**：内置 optreturn 和 optstrategy
- **绘图系统**：matplotlib 集成，完整的 K 线和指标绘图
- **佣金系统**：支持百分比/固定/每手等多种计费模式
- **交易日历**：支持 NYSE/LSE 等，可集成 pandas_market_calendars

#### 数据源（18+ 种）

| 类别 | 数据源 | 状态 |
|------|--------|------|
| 离线 | CSV (通用/BT格式/MT4格式), Pandas DataFrame, Blaze | 完全实现 |
| 在线历史 | Yahoo Finance (yfinance), Quandl | 完全实现 |
| 在线实时 | Interactive Brokers, Oanda, Visual Chart | 部分实现 |
| 中国市场 | AkShare (A股/指数/基金/期货) | 完全实现（历史数据） |
| 加密货币 | CCXT (Binance等) | 部分实现 |
| 数据处理 | Resampler, Replayer, SessionFilter, Renko, HeikinAshi | 完全实现 |

#### 实盘交易模块（real_trade/）

```
real_trade/
├── common/          # 通用基类 ── 90% 完成
│   ├── base_store.py        # Store基类（单例、代理检测、CCXT包装）
│   ├── base_broker.py       # Broker基类（Paper/Live交易逻辑）
│   ├── base_data.py         # DataFeed基类（历史/实时数据）
│   └── base_websocket.py    # WebSocket基类（自动重连、心跳）
├── binance/         # Binance集成 ── 40% 完成
│   ├── store.py             # 连接管理（Spot/Futures/Delivery）
│   ├── broker.py            # 直接继承BaseBroker，无自定义逻辑
│   ├── datafeed.py          # 直接继承BaseData
│   ├── examples/            # 6个示例脚本
│   └── tests/               # 4个功能测试
├── risk/            # 风险管理 ── 95% 完成
│   ├── manager.py           # RiskManager综合决策
│   ├── position_sizer.py    # Fixed/Kelly/ATR仓位计算
│   ├── stop_loss.py         # Fixed/Trailing/ATR止损
│   ├── drawdown.py          # 最大回撤控制
│   └── limits.py            # 交易频率和亏损限制
├── strategies/      # 策略库 ── 50% 完成
│   ├── base.py              # RealTradeStrategyBase
│   ├── trend/               # MA Cross / MACD / SuperTrend
│   ├── momentum/            # RSI / Volume Breakout
│   ├── mean_reversion/      # Bollinger / RSI Reversion
│   ├── grid/                # Fixed/Dynamic Grid
│   └── composite/           # 多指标组合
├── engine/          # 交易引擎 ── 60% 完成
│   ├── runner.py            # TradingRunner统一运行器
│   ├── scheduler.py         # 任务调度（基础）
│   └── lifecycle.py         # 生命周期管理（基础）
├── monitor/         # 监控报告 ── 70% 完成
│   ├── tracker.py           # PerformanceTracker
│   ├── health_check.py      # HealthChecker
│   └── reporter.py          # Reporter（文本+JSON）
├── notifications/   # 通知系统 ── 65% 完成
│   ├── telegram.py          # Telegram通知
│   ├── dingtalk.py          # 钉钉通知
│   ├── email_notify.py      # 邮件通知
│   └── webhook.py           # Webhook通知
└── utils/           # 工具模块 ── 90% 完成
    ├── config.py            # GlobalConfig（JSON/Dict/ENV）
    ├── validators.py        # 参数校验
    ├── logger.py            # 日志配置
    ├── time_utils.py        # 时间工具
    └── retry.py             # 重试装饰器
```

---

## 二、开发规范备忘

以下为项目已确立的开发规范，所有任务实施时必须遵守：

1. **TA-Lib 优先原则**：标准技术指标优先使用 `bt.talib.*`，不重复造轮子。仅 ta-lib 未覆盖的指标（如 SuperTrend, Ichimoku）才自行实现。
2. **交易所模块统一架构**：所有交易所必须继承 `real_trade.common` 下的 BaseStore / BaseBroker / BaseData 基类，禁止重复实现。使用绝对导入，`islive()` 行为统一为 `return not self.params.backtest`。
3. **动态导入**：外部可选依赖一律按需导入（import inside function/method），核心框架不硬依赖任何第三方库。

---

## 三、优先级任务清单

### P0 - 实盘可用的根基

> 不完成这些任务，系统无法安全地用于实盘交易。

#### 1. Binance WebSocket 实时数据集成

- **现状**：`BaseWebSocket` 基类已实现自动重连和心跳，但 Binance 模块完全没有使用，仅靠 HTTP 轮询获取数据
- **目标**：实现基于 WebSocket 的实时行情推送和订单状态更新
- **涉及文件**：
  - `real_trade/binance/store.py` - 添加 WebSocket 连接管理
  - `real_trade/binance/datafeed.py` - 实现 WS 行情数据流
  - `real_trade/common/base_websocket.py` - 可能需要扩展
- **关键点**：
  - 接入 Binance WS 行情流（kline / trade / depth）
  - 接入 User Data Stream（订单更新、账户更新）
  - 利用已有 BaseWebSocket 的重连机制

#### 2. 订单管理完善

- **现状**：`BinanceBroker` 直接继承 `BaseBroker` 无自定义逻辑，订单生命周期管理不完整
- **目标**：完整的订单状态追踪、撤单、改单、部分成交处理
- **涉及文件**：
  - `real_trade/common/base_broker.py` - 增强基类订单管理
  - `real_trade/binance/broker.py` - Binance 特有订单逻辑
- **关键点**：
  - 订单状态机（Submitted -> Accepted -> Partial -> Completed / Cancelled / Rejected）
  - 订单超时重发策略
  - 批量订单支持
  - 订单和持仓的本地缓存同步

#### 3. 异常恢复与状态持久化

- **现状**：网络中断或进程重启后无法恢复交易状态
- **目标**：crash-safe 的交易引擎
- **涉及文件**：
  - `real_trade/engine/runner.py` - 添加状态快照和恢复
  - `real_trade/engine/lifecycle.py` - 完善生命周期钩子
- **关键点**：
  - 定期快照持仓、挂单、账户状态到本地文件
  - 启动时检测上次状态，自动恢复或提示人工确认
  - 网络断线后自动重连并同步交易所真实状态

#### 4. 交易所模块架构统一（已有规范待执行）

- **现状**：Binance 模块存在 `sys.path.insert` hack 式导入，bybit/utils 下有重复工具模块
- **目标**：所有交易所模块严格遵循统一架构规范
- **涉及文件**：
  - `real_trade/binance/` - 替换 hack 导入为绝对导入
  - bybit 模块（如存在）- 废弃重复的 utils，统一使用 `real_trade.utils`
- **关键点**：
  - `from real_trade.common import ...` 替代 `sys.path.insert`
  - `islive()` 统一返回 `not self.params.backtest`
  - 废弃重复工具模块

---

### P1 - 数据可靠性与持久化

> 让系统具备长期运行和数据积累的能力。

#### 5. 数据库持久化层

- **现状**：交易记录、绩效数据、策略状态全在内存，进程退出即丢失
- **目标**：建立统一的数据持久化层
- **建议方案**：SQLite + SQLAlchemy（轻量启动），后续可切换 PostgreSQL
- **需要持久化的数据**：
  - 交易记录（订单、成交、持仓历史）
  - 账户快照（定时记录净值、可用资金、持仓）
  - 策略状态（信号历史、指标值）
  - 绩效指标（日收益率、Sharpe、回撤）
- **涉及文件**：新建 `real_trade/storage/` 模块

#### 6. 数据验证与清洗管道

- **现状**：数据源直接灌入引擎，无质量校验
- **目标**：在数据进入策略前自动校验和修复
- **关键点**：
  - 缺失值检测与处理（前填充 / 插值 / 跳过）
  - 异常值检测（价格突变、成交量异常）
  - K 线连续性检查（时间戳不重复、不跳跃）
  - 数据源切换时的一致性校验

#### 7. 历史数据本地缓存

- **现状**：每次回测需要重新下载数据
- **目标**：本地数据仓库 + 增量更新
- **建议方案**：
  - 使用 Parquet / SQLite 存储历史 K 线
  - 按 symbol + timeframe 索引
  - 自动检测缺失区间并增量补全
- **涉及文件**：可扩展 `tools/` 下的数据下载工具或新建 `real_trade/storage/market_data.py`

---

### P2 - 策略质量与测试保障

> 确保策略在回测和实盘中行为可靠、可验证。

#### 8. 实盘交易集成测试

- **现状**：84 个测试文件主要覆盖核心框架，实盘模块仅约 30% 覆盖
- **目标**：核心交易路径 70%+ 覆盖率
- **测试类型**：
  - **单元测试**：各模块独立功能测试
  - **集成测试**：Binance testnet 端到端流程
  - **Mock 测试**：模拟交易所 API 响应，测试异常处理
  - **回归测试**：策略信号一致性验证
- **涉及文件**：`real_trade/tests/`, `tests/`

#### 9. 策略库完善与风控集成

- **现状**：`real_trade/strategies/` 下多数策略为简单示例，缺止损止盈和风控
- **目标**：每个策略都集成 risk manager
- **关键点**：
  - 策略内自动调用 `RiskManager` 做开仓前检查
  - 使用 `bt.talib.*` 指标（遵循 TA-Lib 优先规范）
  - 参数边界校验和合理默认值
  - 为每个策略编写回测验证脚本

#### 10. 回测与实盘一致性验证框架

- **现状**：回测和实盘走不同代码路径，无法保证行为一致
- **目标**：建立自动化对比框架
- **方案**：
  - 使用历史数据同时运行回测引擎和模拟实盘引擎
  - 对比两者的信号时间点、订单类型、成交价格、持仓变化
  - 输出差异报告，标记不一致的点

---

### P3 - 运维与可观测性

> 让系统在长期运行中可监控、可诊断。

#### 11. 监控告警增强

- **现状**：基础 tracker / reporter，无持久化、无告警去重
- **目标**：生产级监控
- **关键点**：
  - 告警去重和限频（同类告警 N 分钟内只发一次）
  - 绩效数据持久化到数据库（依赖 P1.5）
  - 可选：Prometheus metrics 导出，对接 Grafana 面板
  - 系统健康看板（连接状态、延迟、订单队列深度）

#### 12. 通知系统加固

- **现状**：Telegram / 钉钉 / 邮件 / Webhook 四通道有基础实现
- **目标**：可靠的通知投递
- **关键点**：
  - 失败重试（指数退避）
  - 异步发送队列（不阻塞主交易线程）
  - 消息模板丰富化（支持 markdown 格式、附带图表）
  - 通知优先级（紧急 / 普通 / 低优先级不同渠道）

#### 13. 结构化日志与审计

- **现状**：基本 Python logging
- **目标**：可追溯的操作审计
- **关键点**：
  - JSON 格式结构化日志（方便 ELK / Loki 采集）
  - 订单审计日志（每笔订单的完整生命周期记录）
  - 日志分级存储（交易日志 / 系统日志 / 调试日志）
  - 日志轮转和归档策略

---

### P4 - 工程化与部署

> 降低部署和维护成本。

#### 14. Docker 容器化

- **目标**：一键部署整套系统
- **内容**：
  - Dockerfile（含 TA-Lib C 库预编译）
  - docker-compose.yml（引擎 + SQLite/PostgreSQL + 监控）
  - 环境变量配置模板
  - 健康检查端点

#### 15. 配置管理升级

- **现状**：`real_trade/utils/config.py` 支持 JSON / Dict / ENV
- **目标**：安全、易用的配置体系
- **关键点**：
  - 配置模板生成向导（交互式创建配置文件）
  - 配置校验（pydantic schema，启动时自动验证）
  - 敏感信息加密存储（API key / secret 不以明文保存）
  - 多环境支持（dev / testnet / production）

#### 16. CI/CD 流水线

- **现状**：仅有 `.travis.yml`（过时）
- **目标**：现代化 CI/CD
- **方案**：
  - 迁移到 GitHub Actions
  - 自动运行：单元测试 -> lint -> 类型检查 -> 集成测试
  - 发布流程：自动打 tag -> 构建 Docker 镜像 -> 发布 PyPI

---

### P5 - 多交易所扩展

> 扩大交易市场覆盖面。

#### 17. Bybit / OKX 交易所集成

- **前提**：P0.4 架构统一完成
- **方案**：基于 common 基类 + CCXT，复用 Binance 模式快速实现
- **每个交易所需实现**：
  - `store.py` - 连接管理（继承 BaseStore）
  - `broker.py` - 订单执行（继承 BaseBroker）
  - `datafeed.py` - 数据流（继承 BaseData）
  - WebSocket 集成
  - 交易所特有逻辑（如 Bybit 的统一账户）

#### 18. A 股券商实盘对接

- **现状**：仅有 AkShare 历史数据下载
- **调研方向**：
  - QMT / miniQMT（券商量化接口）
  - CTP（期货）
  - 通达信接口
- **注意**：A 股 T+1 规则、涨跌停限制等需要在 Broker 层特殊处理

---

### P6 - 性能与高级特性

> 长期演进方向。

#### 19. 异步 I/O 支持

- **现状**：全同步阻塞模型
- **目标**：核心数据流路径异步化
- **关键点**：
  - WebSocket / REST API 调用改为 asyncio
  - 数据获取和策略计算可并行
  - 注意：需要保持与现有同步 API 的兼容性

#### 20. 回测性能优化

- **目标**：支持大数据集高效回测
- **关键点**：
  - profiling 定位瓶颈（cProfile / line_profiler）
  - 增量数据加载（替代全量预加载，降低内存占用）
  - 并行参数优化（multiprocessing / joblib）
  - 可选：核心热路径用 Cython / Numba 加速

#### 21. 多账户 / 多策略并行

- **目标**：一个引擎实例管理多个策略和账户
- **关键点**：
  - 策略间资金隔离
  - 多账户持仓独立管理
  - 统一风控（跨策略总风险控制）
  - 调度器分配计算资源

---

## 四、外部依赖参考

本项目所有外部依赖均为可选（动态导入），按功能分组：

| 分组 | 包名 | 用途 |
|------|------|------|
| **核心** | numpy | 数值计算 |
| | pandas | 数据分析与 DataFrame |
| | matplotlib | 图表可视化 |
| **数据源** | yfinance | Yahoo Finance 数据 |
| | akshare | 中国市场数据（A股/指数/基金/期货） |
| | ccxt | 加密货币交易所统一 API |
| **技术分析** | TA-Lib | 技术指标库（需先安装 C 底层库） |
| **交易接口** | oandapy | OANDA 外汇 API |
| | requests | HTTP 客户端 |
| **扩展** | pandas_market_calendars | 交易所交易日历 |
| | influxdb | InfluxDB 时序数据库 |

安装脚本：`python tools/install_deps.py --list` 查看状态，`--all` 一键安装。

---

## 五、里程碑规划

```
M1: 实盘可用（P0 全部完成）
    -> WebSocket 实时数据 + 完整订单管理 + 异常恢复 + 架构统一
    -> 可以在 Binance testnet 安全运行策略

M2: 数据可靠（P1 全部完成）
    -> 数据库持久化 + 数据校验 + 本地缓存
    -> 交易记录可追溯，数据质量有保障

M3: 质量保障（P2 全部完成）
    -> 测试覆盖 70%+ + 策略风控集成 + 回测/实盘一致性验证
    -> 可以在 Binance 主网小资金实盘

M4: 生产运维（P3 + P4 完成）
    -> 监控告警 + 通知 + 日志 + Docker + CI/CD
    -> 可以长期无人值守运行

M5: 多市场覆盖（P5 完成）
    -> Bybit / OKX / A股券商
    -> 多市场多品种交易

M6: 性能进阶（P6 完成）
    -> 异步IO + 性能优化 + 多策略并行
    -> 支持更大规模的交易和回测
```
